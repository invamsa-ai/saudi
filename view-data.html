<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المصادقات - UAE PASS</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #00ac75;
            --error-color: #ff4757;
            --warning-color: #ff9800;
            --dark-color: #343a40;
        }
        
        body {
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
            direction: rtl;
        }
        
        .header {
            background: linear-gradient(135deg, var(--dark-color), #1a237e);
            color: white;
            padding: 25px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .title h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .title p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .back-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-5px);
        }
        
        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* بطاقات الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-top: 4px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: #e3f2fd;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--primary-color);
        }
        
        .stat-content h3 {
            margin: 0;
            font-size: 32px;
            color: var(--dark-color);
        }
        
        .stat-content p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
        
        /* جدول البيانات */
        .data-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-header h2 {
            margin: 0;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background: var(--error-color);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* جدول البيانات */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }
        
        th {
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        tbody tr.selected {
            background-color: #e8f4fd;
            border-left: 3px solid var(--primary-color);
        }
        
        /* شارة الحالة */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 80px;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .badge-approved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* زر الإجراءات */
        .action-cell {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* لوحة التحكم بالمصادقة */
        .auth-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            display: none;
        }
        
        .auth-panel.active {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .auth-header h3 {
            margin: 0;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .auth-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .auth-form {
            background: white;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            text-align: center;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .auth-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            margin: 10px 0;
            color: var(--dark-color);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* التنبيهات */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
            border-right: 4px solid var(--primary-color);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-success {
            border-right-color: var(--success-color);
        }
        
        .toast-error {
            border-right-color: var(--error-color);
        }
        
        .toast-warning {
            border-right-color: var(--warning-color);
        }
        
        .toast-info {
            border-right-color: var(--primary-color);
        }
        
        /* حالة التحميل */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading i {
            font-size: 40px;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* الوضع المحمول */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .controls {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .auth-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* تأثيرات إضافية */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .shake {
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- الهيدر -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">
                    <i class="fas fa-database"></i>
                </div>
                <div class="title">
                    <h1><i class="fas fa-key"></i> إدارة المصادقات - UAE PASS</h1>
                    <p>لوحة تحكم المسؤول - إدارة أرقام الهوية والمصادقات</p>
                </div>
            </div>
            <a href="apply.html" class="back-button">
                <i class="fas fa-arrow-right"></i> العودة للتسجيل
            </a>
        </div>
    </header>

    <!-- حاوية التنبيهات -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- المحتوى الرئيسي -->
    <div class="main-container">
        <!-- بطاقات الإحصائيات -->
        <div class="stats-grid" id="statsContainer">
            <!-- سيتم ملؤها بالجافاسكريبت -->
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>جاري تحميل الإحصائيات...</p>
            </div>
        </div>

        <!-- لوحة التحكم بالمصادقة -->
        <div class="auth-panel" id="authPanel">
            <div class="auth-header">
                <h3><i class="fas fa-edit"></i> إدارة المصادقة المحددة</h3>
                <button class="btn btn-danger" onclick="closeAuthPanel()">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
            
            <div class="auth-info">
                <div class="auth-info-grid" id="recordInfo">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </div>
            
            <div class="auth-form">
                <div class="form-group">
                    <label for="authCodeInput">
                        <i class="fas fa-key"></i> رقم المصادقة الجديد (00-99)
                    </label>
                    <input type="text" 
                           id="authCodeInput" 
                           class="form-control"
                           placeholder="أدخل رقم مصادقة مكون من خانتين"
                           maxlength="2"
                           pattern="[0-9]{2}"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    <small class="text-muted" style="display: block; margin-top: 5px;">
                        يجب أن يكون رقم المصادقة بين 00 و 99
                    </small>
                </div>
                
                <div class="auth-display" id="authDisplay">
                    ??
                </div>
                
                <div class="auth-actions">
                    <button class="btn btn-success btn-lg" onclick="approveWithCode()">
                        <i class="fas fa-check-circle"></i> موافقة مع الرقم
                    </button>
                    <button class="btn btn-danger btn-lg" onclick="rejectRecord()">
                        <i class="fas fa-times-circle"></i> رفض بدون رقم
                    </button>
                    <button class="btn btn-warning" onclick="testSendCode()">
                        <i class="fas fa-paper-plane"></i> اختبار الإرسال
                    </button>
                </div>
            </div>
        </div>

        <!-- قسم بيانات أرقام الهوية -->
        <div class="data-section">
            <div class="section-header">
                <h2><i class="fas fa-id-card"></i> جميع طلبات المصادقة</h2>
                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" 
                               id="searchInput" 
                               placeholder="ابحث برقم الهوية، الحالة، أو التاريخ...">
                    </div>
                    
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterRecords('all')">الكل</button>
                        <button class="filter-btn" onclick="filterRecords('pending')">بانتظار المصادقة</button>
                        <button class="filter-btn" onclick="filterRecords('approved')">مصدق</button>
                        <button class="filter-btn" onclick="filterRecords('rejected')">مرفوض</button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> تحديث
                        </button>
                        <button class="btn btn-info" onclick="exportData()">
                            <i class="fas fa-download"></i> تصدير
                        </button>
                        <button class="btn btn-warning" onclick="clearOldRecords()">
                            <i class="fas fa-trash-alt"></i> تنظيف
                        </button>
                    </div>
                </div>
            </div>

            <!-- جدول البيانات -->
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>رقم الهوية</th>
                            <th>رقم المصادقة</th>
                            <th>تاريخ الإنشاء</th>
                            <th>الحالة</th>
                            <th>آخر تحديث</th>
                            <th>عنوان IP</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>جاري تحميل البيانات...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="pagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <!-- سيتم إضافة ترقيم الصفحات هنا -->
            </div>
        </div>
    </div>

   <script>
    // إعدادات Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAk27c6KL77QbnXa_bNeWzUsBph5o7I9A8",
        authDomain: "uaewep-ce954.firebaseapp.com",
        databaseURL: "https://uaewep-ce954-default-rtdb.firebaseio.com",
        projectId: "uaewep-ce954",
        storageBucket: "uaewep-ce954.firebasestorage.app",
        messagingSenderId: "1047721328905",
        appId: "1:1047721328905:web:599b1675bc680f37f93e54"
    };

    // المتغيرات العامة
    let firebaseApp;
    let database;
    let currentRecords = [];
    let selectedRecord = null;

    // دالة تهيئة Firebase
    function initializeFirebase() {
        console.log('جاري تهيئة Firebase...');
        
        try {
            if (typeof firebaseConfig === 'undefined') {
                console.error('❌ firebaseConfig غير معرف!');
                showToast('خطأ', 'لم يتم تحميل إعدادات قاعدة البيانات', 'error');
                return false;
            }
            
            console.log('✅ firebaseConfig موجود');
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('✅ Firebase تم تهيئته بنجاح');
            } else {
                firebaseApp = firebase.app();
                database = firebase.database();
                console.log('✅ Firebase مثبت بالفعل');
            }
            
            return true;
            
        } catch (error) {
            console.error('❌ خطأ في تهيئة Firebase:', error);
            showToast('خطأ', 'فشل في الاتصال بقاعدة البيانات', 'error');
            return false;
        }
    }

    // دالة عرض التنبيهات
    function showToast(title, message, type = 'info') {
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container';
            toastContainer.id = 'toastContainer';
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        
        const icon = type === 'success' ? 'check-circle' :
                    type === 'error' ? 'exclamation-circle' :
                    type === 'warning' ? 'exclamation-triangle' : 'info-circle';
        
        const color = type === 'success' ? '#00ac75' :
                     type === 'error' ? '#ff4757' :
                     type === 'warning' ? '#ff9800' : '#007bff';
        
        toast.innerHTML = `
            <div class="toast-icon" style="color: ${color};">
                <i class="fas fa-${icon}"></i>
            </div>
            <div>
                <strong>${title}</strong>
                <p style="margin: 5px 0 0 0; font-size: 14px;">${message}</p>
            </div>
            <button onclick="this.parentElement.remove()" style="
                background: none;
                border: none;
                color: #999;
                cursor: pointer;
                padding: 5px;
                margin-left: auto;
            ">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // دالة تحميل جميع البيانات
    async function loadAllData() {
        if (!initializeFirebase()) return;
        
        showLoading();
        
        try {
            const snapshot = await database.ref('authentications').once('value');
            const data = snapshot.val();
            
            currentRecords = [];
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const record = {
                        id: key,
                        ...data[key]
                    };
                    
                    // تحويل timestamp إلى تاريخ مقروء
                    if (record.timestamp) {
                        const date = new Date(record.timestamp);
                        record.createdAt = date.toLocaleString('ar-EG');
                        record.dateOnly = date.toLocaleDateString('ar-EG');
                        record.timeOnly = date.toLocaleTimeString('ar-EG');
                    }
                    
                    currentRecords.push(record);
                });
                
                // ترتيب حسب التاريخ (الأحدث أولاً)
                currentRecords.sort((a, b) => {
                    if (!a.timestamp) return 1;
                    if (!b.timestamp) return -1;
                    return b.timestamp - a.timestamp;
                });
            }
            
            updateStats();
            renderTable();
            hideLoading();
            
        } catch (error) {
            console.error('❌ خطأ في تحميل البيانات:', error);
            showToast('خطأ', 'فشل في تحميل البيانات', 'error');
            hideLoading();
        }
    }

    // تحديث الإحصائيات
    function updateStats() {
        const total = currentRecords.length;
        const pending = currentRecords.filter(r => !r.auth_code || r.status === 'pending').length;
        const approved = currentRecords.filter(r => r.status === 'approved').length;
        const rejected = currentRecords.filter(r => r.status === 'rejected').length;

        document.getElementById('statsContainer').innerHTML = `
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-id-card"></i>
                </div>
                <div class="stat-content">
                    <h3>${total}</h3>
                    <p>إجمالي الطلبات</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="color: #ff9800; background: #fff3cd;">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>${pending}</h3>
                    <p>بانتظار المصادقة</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="color: #00ac75; background: #d4edda;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>${approved}</h3>
                    <p>مصدق عليها</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="color: #ff4757; background: #f8d7da;">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>${rejected}</h3>
                    <p>مرفوضة</p>
                </div>
            </div>
        `;
    }

    // عرض البيانات في الجدول
    function renderTable() {
        const tableBody = document.getElementById('tableBody');
        
        if (currentRecords.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div style="font-size: 60px; color: #dee2e6; margin-bottom: 20px;">
                            <i class="fas fa-database"></i>
                        </div>
                        <h3 style="color: #6c757d;">لا توجد بيانات حالياً</h3>
                        <p>لم يتم تسجيل أي أرقام هوية بعد</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        
        currentRecords.forEach((record, index) => {
            // تحديد شارة الحالة
            let statusBadge = '';
            let statusClass = '';
            let authCodeDisplay = record.auth_code || '-';
            let authCodeClass = '';
            
            if (record.status === 'approved') {
                statusBadge = '<span class="badge badge-approved">مصدق</span>';
                statusClass = 'approved';
                if (record.auth_code) {
                    authCodeDisplay = '<strong style="color: #00ac75; font-size: 16px;">' + record.auth_code + '</strong>';
                    authCodeClass = 'approved-code';
                }
            } else if (record.status === 'rejected') {
                statusBadge = '<span class="badge badge-rejected">مرفوض</span>';
                statusClass = 'rejected';
                authCodeDisplay = '-';
            } else {
                statusBadge = '<span class="badge badge-pending">بانتظار</span>';
                statusClass = 'pending';
                if (record.auth_code) {
                    authCodeDisplay = '<strong style="color: #007bff; font-size: 16px;">' + record.auth_code + '</strong>';
                    authCodeClass = 'pending-code';
                } else {
                    authCodeDisplay = '<span style="color: #ff9800;">لم يدخل بعد</span>';
                }
            }
            
            html += `
                <tr class="${statusClass}" onclick="selectRecord('${record.id}')" style="cursor: pointer;">
                    <td>${index + 1}</td>
                    <td>
                        <div style="font-weight: bold; font-size: 16px; color: #343a40;">
                            ${record.id_number || record.id}
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            <i class="fas fa-fingerprint"></i> ${record.id}
                        </div>
                    </td>
                    <td class="${authCodeClass}">
                        ${authCodeDisplay}
                    </td>
                    <td>
                        <div>${record.dateOnly || ''}</div>
                        <div style="font-size: 12px; color: #666;">${record.timeOnly || ''}</div>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div>${record.createdAt || '-'}</div>
                        ${record.auth_code_updated_at ? 
                            '<div style="font-size: 11px; color: #999;">تم التحديث: ' + new Date(record.auth_code_updated_at).toLocaleTimeString('ar-EG') + '</div>' : 
                            ''}
                    </td>
                    <td>
                        <div style="font-size: 12px;">${record.ip || 'غير معروف'}</div>
                    </td>
                    <td>
                        <div class="action-cell">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openAuthPanel('${record.id}')">
                                <i class="fas fa-key"></i> إدخال رمز
                            </button>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); approveRecord('${record.id}')" ${record.auth_code ? '' : 'disabled title="يجب إدخال رمز أولاً" style="opacity: 0.5;"'}>
                                <i class="fas fa-check"></i> موافقة
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); rejectRecord('${record.id}')">
                                <i class="fas fa-times"></i> رفض
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    // فتح لوحة إدخال رمز المصادقة
    function openAuthPanel(recordId) {
        selectedRecord = currentRecords.find(r => r.id === recordId);
        
        if (!selectedRecord) {
            showToast('خطأ', 'لم يتم العثور على السجل', 'error');
            return;
        }
        
        // تحديث معلومات السجل
        document.getElementById('recordInfo').innerHTML = `
            <div class="info-item">
                <span class="info-label">رقم الهوية</span>
                <span class="info-value" style="font-size: 20px; color: #007bff; font-weight: bold;">
                    ${selectedRecord.id_number || selectedRecord.id}
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">التاريخ</span>
                <span class="info-value">${selectedRecord.dateOnly || ''}</span>
            </div>
            <div class="info-item">
                <span class="info-label">الوقت</span>
                <span class="info-value">${selectedRecord.timeOnly || ''}</span>
            </div>
            <div class="info-item">
                <span class="info-label">الرمز الحالي</span>
                <span class="info-value" style="font-size: 24px; color: ${selectedRecord.auth_code ? '#00ac75' : '#ff4757'}; font-weight: bold;">
                    ${selectedRecord.auth_code || 'لم يتم إدخاله'}
                </span>
            </div>
        `;
        
        // إعداد حقل الإدخال
        const codeInput = document.getElementById('authCodeInput');
        const authDisplay = document.getElementById('authDisplay');
        
        codeInput.value = selectedRecord.auth_code || '';
        authDisplay.textContent = selectedRecord.auth_code || '??';
        authDisplay.style.color = selectedRecord.auth_code ? '#00ac75' : '#343a40';
        
        // إظهار لوحة التحكم
        document.getElementById('authPanel').classList.add('active');
        
        // التركيز على حقل الإدخال
        setTimeout(() => {
            codeInput.focus();
        }, 300);
    }

    // إغلاق لوحة التحكم
    function closeAuthPanel() {
        document.getElementById('authPanel').classList.remove('active');
        selectedRecord = null;
    }

    // تحديث عرض الرمز عند الكتابة
    document.getElementById('authCodeInput').addEventListener('input', function(e) {
        const code = e.target.value;
        const display = document.getElementById('authDisplay');
        
        if (code.length === 2 && /^\d{2}$/.test(code)) {
            display.textContent = code;
            display.style.color = '#00ac75';
            display.style.borderColor = '#00ac75';
        } else if (code.length > 0) {
            display.textContent = code.padEnd(2, '?');
            display.style.color = '#ff9800';
            display.style.borderColor = '#ff9800';
        } else {
            display.textContent = '??';
            display.style.color = '#343a40';
            display.style.borderColor = '#dee2e6';
        }
    });

    // حفظ رمز المصادقة
    async function saveAuthCode() {
        if (!selectedRecord) {
            showToast('خطأ', 'لم يتم تحديد سجل', 'error');
            return;
        }
        
        const codeInput = document.getElementById('authCodeInput');
        const code = codeInput.value.trim();
        
        // التحقق من صحة الرمز
        if (!/^\d{2}$/.test(code)) {
            showToast('خطأ', 'الرجاء إدخال رمز صحيح مكون من خانتين (00-99)', 'error');
            codeInput.classList.add('shake');
            setTimeout(() => codeInput.classList.remove('shake'), 500);
            codeInput.focus();
            return;
        }
        
        try {
            // تحديث البيانات في Firebase
            await database.ref('authentications/' + selectedRecord.id).update({
                auth_code: code,
                auth_code_updated_at: firebase.database.ServerValue.TIMESTAMP,
                last_updated: firebase.database.ServerValue.TIMESTAMP
            });
            
            showToast('نجاح', 'تم حفظ رمز المصادقة ' + code + ' للرقم ' + (selectedRecord.id_number || selectedRecord.id), 'success');
            
            // إغلاق اللوحة بعد تأخير
            setTimeout(() => {
                closeAuthPanel();
                loadAllData();
            }, 1500);
            
        } catch (error) {
            console.error('❌ خطأ في حفظ الرمز:', error);
            showToast('خطأ', 'فشل في حفظ الرمز', 'error');
        }
    }

    // ✅ الدالة التي ينقصها - حفظ وموافقة معاً
    async function approveWithCode() {
        if (!selectedRecord) {
            showToast('خطأ', 'لم يتم تحديد سجل', 'error');
            return;
        }
        
        const codeInput = document.getElementById('authCodeInput');
        const code = codeInput.value.trim();
        
        // التحقق من صحة الرمز
        if (!/^\d{2}$/.test(code)) {
            showToast('خطأ', 'الرجاء إدخال رمز صحيح مكون من خانتين (00-99)', 'error');
            codeInput.classList.add('shake');
            setTimeout(() => codeInput.classList.remove('shake'), 500);
            codeInput.focus();
            return;
        }
        
        try {
            // تحديث البيانات في Firebase - حفظ الرمز والموافقة معاً
            await database.ref('authentications/' + selectedRecord.id).update({
                auth_code: code,
                auth_code_updated_at: firebase.database.ServerValue.TIMESTAMP,
                status: 'approved',
                approved_at: firebase.database.ServerValue.TIMESTAMP,
                approved_by: 'admin',
                last_updated: firebase.database.ServerValue.TIMESTAMP
            });
            
            showToast('نجاح', 'تم حفظ الرمز ' + code + ' والموافقة على السجل', 'success');
            
            // إغلاق اللوحة بعد تأخير
            setTimeout(() => {
                closeAuthPanel();
                loadAllData();
            }, 1500);
            
        } catch (error) {
            console.error('❌ خطأ في الحفظ والموافقة:', error);
            showToast('خطأ', 'فشل في الحفظ والموافقة', 'error');
        }
    }

    // الموافقة على السجل
    async function approveRecord(recordId) {
        const record = currentRecords.find(r => r.id === recordId);
        
        if (!record) {
            showToast('خطأ', 'لم يتم العثور على السجل', 'error');
            return;
        }
        
        if (!record.auth_code) {
            showToast('تحذير', 'يجب إدخال رمز مصادقة أولاً', 'warning');
            openAuthPanel(recordId);
            return;
        }
        
        if (confirm('هل تريد الموافقة على السجل برقم الهوية: ' + (record.id_number || record.id) + ' والرمز: ' + record.auth_code + '؟')) {
            try {
                await database.ref('authentications/' + recordId).update({
                    status: 'approved',
                    approved_at: firebase.database.ServerValue.TIMESTAMP,
                    approved_by: 'admin',
                    last_updated: firebase.database.ServerValue.TIMESTAMP
                });
                
                showToast('نجاح', 'تمت الموافقة بنجاح', 'success');
                loadAllData();
                
            } catch (error) {
                console.error('❌ خطأ في الموافقة:', error);
                showToast('خطأ', 'فشل في الموافقة', 'error');
            }
        }
    }

    // رفض السجل
    async function rejectRecord(recordId) {
        const record = currentRecords.find(r => r.id === recordId);
        
        if (!record) {
            showToast('خطأ', 'لم يتم العثور على السجل', 'error');
            return;
        }
        
        if (confirm('هل تريد رفض السجل برقم الهوية: ' + (record.id_number || record.id) + '؟')) {
            try {
                await database.ref('authentications/' + recordId).update({
                    status: 'rejected',
                    rejected_at: firebase.database.ServerValue.TIMESTAMP,
                    rejected_by: 'admin',
                    last_updated: firebase.database.ServerValue.TIMESTAMP
                });
                
                showToast('نجاح', 'تم الرفض بنجاح', 'success');
                loadAllData();
                
            } catch (error) {
                console.error('❌ خطأ في الرفض:', error);
                showToast('خطأ', 'فشل في الرفض', 'error');
            }
        }
    }

    // تحديد السجل
    function selectRecord(recordId) {
        document.querySelectorAll('tr').forEach(row => {
            row.classList.remove('selected');
        });
        
        const selectedRow = document.querySelector('tr[onclick*="' + recordId + '"]');
        if (selectedRow) {
            selectedRow.classList.add('selected');
        }
    }

    // تحديث البيانات
    function refreshData() {
        loadAllData();
        showToast('معلومات', 'جاري تحديث البيانات...', 'info');
    }

    // تصدير البيانات
    function exportData() {
        if (currentRecords.length === 0) {
            showToast('تحذير', 'لا توجد بيانات للتصدير', 'warning');
            return;
        }
        
        let csv = 'رقم الهوية,رمز المصادقة,التاريخ,الوقت,الحالة,تاريخ الإنشاء,آخر تحديث\n';
        
        currentRecords.forEach(record => {
            csv += '"' + (record.id_number || record.id) + '","' + (record.auth_code || '') + '","' + (record.dateOnly || '') + '",';
            csv += '"' + (record.timeOnly || '') + '","' + (record.status || 'pending') + '","' + (record.createdAt || '') + '",';
            csv += '"' + (record.auth_code_updated_at ? new Date(record.auth_code_updated_at).toLocaleString('ar-EG') : '') + '"\n';
        });
        
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', 'authentications_' + new Date().toISOString().split('T')[0] + '.csv');
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('نجاح', 'تم تصدير البيانات بنجاح', 'success');
    }

    // تصفية السجلات
    function filterRecords(filterType) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        let filtered = currentRecords;
        
        switch(filterType) {
            case 'pending':
                filtered = currentRecords.filter(r => !r.auth_code || r.status === 'pending');
                break;
            case 'approved':
                filtered = currentRecords.filter(r => r.status === 'approved');
                break;
            case 'rejected':
                filtered = currentRecords.filter(r => r.status === 'rejected');
                break;
        }
        
        renderFilteredTable(filtered);
    }

    // عرض الجدول المفلتر
    function renderFilteredTable(filteredRecords) {
        const tableBody = document.getElementById('tableBody');
        
        if (filteredRecords.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h4>لا توجد نتائج</h4>
                        <p>لم يتم العثور على سجلات مطابقة</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        
        filteredRecords.forEach((record, index) => {
            let statusBadge = '';
            let authCodeDisplay = record.auth_code || '-';
            
            if (record.status === 'approved') {
                statusBadge = '<span class="badge badge-approved">مصدق</span>';
                if (record.auth_code) {
                    authCodeDisplay = '<strong style="color: #00ac75;">' + record.auth_code + '</strong>';
                }
            } else if (record.status === 'rejected') {
                statusBadge = '<span class="badge badge-rejected">مرفوض</span>';
            } else {
                statusBadge = '<span class="badge badge-pending">بانتظار</span>';
                if (record.auth_code) {
                    authCodeDisplay = '<strong style="color: #007bff;">' + record.auth_code + '</strong>';
                }
            }
            
            html += `
                <tr onclick="selectRecord('${record.id}')" style="cursor: pointer;">
                    <td>${index + 1}</td>
                    <td>${record.id_number || record.id}</td>
                    <td>${authCodeDisplay}</td>
                    <td>
                        <div>${record.dateOnly || ''}</div>
                        <div style="font-size: 12px; color: #666;">${record.timeOnly || ''}</div>
                    </td>
                    <td>${statusBadge}</td>
                    <td>${record.createdAt || '-'}</td>
                    <td>${record.ip || 'غير معروف'}</td>
                    <td>
                        <div class="action-cell">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openAuthPanel('${record.id}')">
                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = html;
    }

    // البحث في الجدول
    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                const filtered = currentRecords.filter(record => {
                    return (
                        (record.id_number && record.id_number.toLowerCase().includes(searchTerm)) ||
                        (record.id && record.id.toLowerCase().includes(searchTerm)) ||
                        (record.auth_code && record.auth_code.includes(searchTerm)) ||
                        (record.status && record.status.includes(searchTerm))
                    );
                });
                
                renderFilteredTable(filtered);
            });
        }
    }

    // إظهار حالة التحميل
    function showLoading() {
        const tableBody = document.getElementById('tableBody');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>جاري تحميل البيانات...</p>
                    </td>
                </tr>
            `;
        }
    }

    function hideLoading() {
        // يتم التعامل معه في renderTable
    }

    // عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
        initializeFirebase();
        loadAllData();
        setupSearch();
        
        // تحديث تلقائي كل 30 ثانية
        setInterval(loadAllData, 30000);
        
        // إغلاق اللوحة بـ ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAuthPanel();
            }
        });
    });
</script>
</body>
</html>
